{% extends "base.html" %}

{% block title %}Database View - Cursor Chats{% endblock %}

{% block extra_head %}
<style>
    /* Database View Container */
    .database-view {
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    /* Toolbar */
    .database-toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 20px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
    }
    
    .database-toolbar .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .database-toolbar label {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .database-toolbar select {
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        font-family: inherit;
        background: var(--bg-secondary);
        color: var(--text-primary);
        cursor: pointer;
        transition: border-color 0.15s;
        min-width: 120px;
    }
    
    .database-toolbar select:hover {
        border-color: var(--accent-blue);
    }
    
    .database-toolbar select:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 2px rgba(86, 156, 214, 0.15);
    }
    
    .database-toolbar .stats {
        margin-left: auto;
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .database-toolbar .stats strong {
        color: var(--text-primary);
    }
    
    /* Table Container */
    .table-container {
        overflow-x: auto;
    }
    
    /* Database Table */
    .database-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    
    .database-table th {
        background: var(--bg-tertiary);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        transition: background 0.15s;
    }
    
    .database-table th:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }
    
    .database-table th.sorted-asc::after {
        content: " ↑";
        color: var(--accent-blue);
    }
    
    .database-table th.sorted-desc::after {
        content: " ↓";
        color: var(--accent-blue);
    }
    
    .database-table th.sorted-asc,
    .database-table th.sorted-desc {
        color: var(--accent-blue);
    }
    
    .database-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .database-table tr:hover td {
        background: var(--bg-hover);
    }
    
    .database-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Column-specific styles */
    .col-title {
        min-width: 250px;
        max-width: 400px;
    }
    
    .col-title a {
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 500;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        transition: color 0.15s;
    }
    
    .col-title a:hover {
        color: var(--accent-blue);
    }
    
    .col-mode {
        width: 100px;
    }
    
    .col-source {
        width: 90px;
    }
    
    .col-messages {
        width: 90px;
        text-align: center;
    }
    
    .col-date {
        width: 110px;
        white-space: nowrap;
    }
    
    .col-workspace {
        min-width: 150px;
        max-width: 250px;
    }
    
    .col-workspace span {
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    .col-tags {
        min-width: 150px;
    }
    
    /* Badges */
    .mode-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .mode-badge.chat { background: rgba(86, 156, 214, 0.2); color: var(--accent-blue); }
    .mode-badge.edit { background: rgba(206, 145, 120, 0.2); color: var(--accent-orange); }
    .mode-badge.agent { background: rgba(197, 134, 192, 0.2); color: var(--accent-purple); }
    .mode-badge.composer { background: rgba(197, 134, 192, 0.2); color: var(--accent-purple); }
    .mode-badge.plan { background: rgba(78, 201, 176, 0.2); color: var(--accent-green); }
    .mode-badge.debug { background: rgba(255, 123, 99, 0.2); color: #ff7b63; }
    .mode-badge.ask { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
    
    .source-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .source-badge.cursor {
        background: rgba(86, 156, 214, 0.15);
        color: var(--accent-blue);
    }
    
    .source-badge.claude {
        background: rgba(197, 134, 192, 0.15);
        color: var(--accent-purple);
    }
    
    .messages-count {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 12px;
    }
    
    .messages-count.zero {
        background: rgba(206, 145, 120, 0.15);
        color: var(--accent-orange);
    }
    
    .messages-count.low {
        background: rgba(255, 193, 7, 0.15);
        color: #ffc107;
    }
    
    .messages-count.medium {
        background: rgba(78, 201, 176, 0.15);
        color: var(--accent-green);
    }
    
    .messages-count.high {
        background: rgba(86, 156, 214, 0.15);
        color: var(--accent-blue);
    }
    
    /* Tags in table */
    .tag-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .tag-pill {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .tag-pill.tech { background: rgba(86, 156, 214, 0.15); color: var(--accent-blue); }
    .tag-pill.activity { background: rgba(78, 201, 176, 0.15); color: var(--accent-green); }
    .tag-pill.topic { background: rgba(197, 134, 192, 0.15); color: var(--accent-purple); }
    .tag-pill.other { background: rgba(206, 145, 120, 0.15); color: var(--accent-orange); }
    
    .tag-pill.more {
        background: var(--bg-tertiary);
        color: var(--text-muted);
    }
    
    /* Favorite column */
    .col-favorite {
        width: 50px;
        text-align: center;
    }
    
    .favorite-btn {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--text-muted);
        padding: 4px;
        border-radius: 4px;
        transition: all 0.15s;
        line-height: 1;
    }
    
    .favorite-btn:hover {
        color: #ffd700;
        transform: scale(1.1);
    }
    
    .favorite-btn.favorited {
        color: #ffd700;
    }
    
    /* Date styling */
    .date-cell {
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    .date-cell .time {
        color: var(--text-muted);
        font-size: 11px;
    }
    
    /* Pagination */
    .database-pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-color);
    }
    
    .database-pagination .page-info {
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .database-pagination .page-controls {
        display: flex;
        gap: 8px;
    }
    
    .database-pagination button,
    .database-pagination a {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.15s;
    }
    
    .database-pagination button:hover:not(:disabled),
    .database-pagination a:hover {
        background: var(--bg-hover);
        border-color: var(--accent-blue);
    }
    
    .database-pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .database-pagination .page-number {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 24px;
        color: var(--text-secondary);
    }
    
    .empty-state p {
        margin-bottom: 12px;
    }
    
    .empty-state code {
        background: var(--bg-tertiary);
        padding: 4px 10px;
        border-radius: 5px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        color: var(--accent-orange);
    }
    
    /* View toggle */
    .view-toggle {
        display: flex;
        gap: 4px;
        background: var(--bg-tertiary);
        padding: 4px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    
    .view-toggle a {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.15s;
    }
    
    .view-toggle a:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }
    
    .view-toggle a.active {
        background: var(--accent-blue);
        color: white;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .database-toolbar {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .database-toolbar .stats {
            margin-left: 0;
            margin-top: 8px;
        }
        
        .col-workspace,
        .col-tags {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="database-view">
    <div class="database-toolbar">
        <div class="view-toggle">
            <a href="{{ url_for('index', filter=current_filter or '', page=page) }}">List</a>
            <a href="{{ url_for('database_view', filter=current_filter or '', page=page, sort=sort_by, order=sort_order) }}" class="active">Database</a>
        </div>
        
        <div class="filter-group">
            <label>Filter:</label>
            <select id="filter-select" onchange="applyFilters()">
                <option value="" {% if not current_filter %}selected{% endif %}>All chats</option>
                <option value="empty" {% if current_filter == 'empty' %}selected{% endif %}>Empty only</option>
                <option value="non_empty" {% if current_filter == 'non_empty' %}selected{% endif %}>Non-empty only</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Mode:</label>
            <select id="mode-filter" onchange="applyFilters()">
                <option value="" {% if not mode_filter %}selected{% endif %}>All modes</option>
                <option value="chat" {% if mode_filter == 'chat' %}selected{% endif %}>Chat</option>
                <option value="agent" {% if mode_filter == 'agent' %}selected{% endif %}>Agent</option>
                <option value="composer" {% if mode_filter == 'composer' %}selected{% endif %}>Composer</option>
                <option value="edit" {% if mode_filter == 'edit' %}selected{% endif %}>Edit</option>
                <option value="plan" {% if mode_filter == 'plan' %}selected{% endif %}>Plan</option>
                <option value="ask" {% if mode_filter == 'ask' %}selected{% endif %}>Ask</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Source:</label>
            <select id="source-filter" onchange="applyFilters()">
                <option value="" {% if not source_filter %}selected{% endif %}>All sources</option>
                <option value="cursor" {% if source_filter == 'cursor' %}selected{% endif %}>Cursor</option>
                <option value="claude.ai" {% if source_filter == 'claude.ai' %}selected{% endif %}>Claude.ai</option>
            </select>
        </div>
        
        <span class="stats">
            Showing <strong>{{ chats|length }}</strong> of <strong>{{ total_chats }}</strong> chats
        </span>
    </div>
    
    <div class="table-container">
        {% if chats %}
        <table class="database-table">
            <thead>
                <tr>
                    <th class="col-favorite">★</th>
                    <th class="col-title {{ 'sorted-asc' if sort_by == 'title' and sort_order == 'asc' else 'sorted-desc' if sort_by == 'title' and sort_order == 'desc' else '' }}" 
                        onclick="sortBy('title')">Title</th>
                    <th class="col-mode {{ 'sorted-asc' if sort_by == 'mode' and sort_order == 'asc' else 'sorted-desc' if sort_by == 'mode' and sort_order == 'desc' else '' }}" 
                        onclick="sortBy('mode')">Mode</th>
                    <th class="col-source {{ 'sorted-asc' if sort_by == 'source' and sort_order == 'asc' else 'sorted-desc' if sort_by == 'source' and sort_order == 'desc' else '' }}" 
                        onclick="sortBy('source')">Source</th>
                    <th class="col-messages {{ 'sorted-asc' if sort_by == 'messages' and sort_order == 'asc' else 'sorted-desc' if sort_by == 'messages' and sort_order == 'desc' else '' }}" 
                        onclick="sortBy('messages')">Messages</th>
                    <th class="col-date {{ 'sorted-asc' if sort_by == 'created_at' and sort_order == 'asc' else 'sorted-desc' if sort_by == 'created_at' and sort_order == 'desc' else '' }}" 
                        onclick="sortBy('created_at')">Created</th>
                    <th class="col-workspace">Workspace</th>
                    <th class="col-tags">Tags</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in chats %}
                <tr>
                    <td class="col-favorite">
                        <button class="favorite-btn" data-favorite-id="{{ chat.id }}" onclick="toggleFavorite({{ chat.id }}, event)" title="Add to favorites">☆</button>
                    </td>
                    <td class="col-title">
                        <a href="{{ url_for('chat_detail', chat_id=chat.id) }}" title="{{ chat.title or 'Untitled Chat' }}">
                            {{ chat.title or 'Untitled Chat' }}
                        </a>
                    </td>
                    <td class="col-mode">
                        <span class="mode-badge {{ chat.mode }}">{{ chat.mode }}</span>
                    </td>
                    <td class="col-source">
                        <span class="source-badge {% if chat.source == 'claude.ai' %}claude{% else %}cursor{% endif %}">
                            {{ chat.source or 'cursor' }}
                        </span>
                    </td>
                    <td class="col-messages">
                        {% set msg_count = chat.messages_count or 0 %}
                        <span class="messages-count {% if msg_count == 0 %}zero{% elif msg_count < 5 %}low{% elif msg_count < 20 %}medium{% else %}high{% endif %}">
                            {{ msg_count }}
                        </span>
                    </td>
                    <td class="col-date">
                        {% if chat.created_at %}
                        <span class="date-cell">
                            {{ chat.created_at[:10] }}
                            <span class="time">{{ chat.created_at[11:16] if chat.created_at|length > 16 else '' }}</span>
                        </span>
                        {% else %}
                        <span class="date-cell">—</span>
                        {% endif %}
                    </td>
                    <td class="col-workspace">
                        {% if chat.workspace_path %}
                        <span title="{{ chat.workspace_path }}">{{ chat.workspace_path.split('/')[-1] if chat.workspace_path else '—' }}</span>
                        {% else %}
                        <span>—</span>
                        {% endif %}
                    </td>
                    <td class="col-tags">
                        {% if chat.tags %}
                        <div class="tag-pills">
                            {% for tag in chat.tags[:3] %}
                            {% set dimension = tag.split('/')[0] if '/' in tag else 'other' %}
                            <span class="tag-pill {{ dimension }}">{{ tag.split('/')[-1] if '/' in tag else tag }}</span>
                            {% endfor %}
                            {% if chat.tags|length > 3 %}
                            <span class="tag-pill more">+{{ chat.tags|length - 3 }}</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <span style="color: var(--text-muted);">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>No chats found{% if current_filter or mode_filter or source_filter %} matching the filters{% endif %}.</p>
            <p>Run <code>python -m src ingest</code> to import chats from Cursor.</p>
        </div>
        {% endif %}
    </div>
    
    {% if total_chats > limit %}
    <div class="database-pagination">
        <span class="page-info">
            Page {{ page }} of {{ ((total_chats - 1) // limit) + 1 }}
        </span>
        <div class="page-controls">
            {% if page > 1 %}
            <a href="{{ url_for('database_view', page=page-1, filter=current_filter or '', mode=mode_filter or '', source=source_filter or '', sort=sort_by, order=sort_order) }}">← Previous</a>
            {% else %}
            <button disabled>← Previous</button>
            {% endif %}
            
            <span class="page-number" style="padding: 6px 14px;">{{ page }}</span>
            
            {% if has_next %}
            <a href="{{ url_for('database_view', page=page+1, filter=current_filter or '', mode=mode_filter or '', source=source_filter or '', sort=sort_by, order=sort_order) }}">Next →</a>
            {% else %}
            <button disabled>Next →</button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% block extra_scripts %}
<script>
    function applyFilters() {
        const filter = document.getElementById('filter-select').value;
        const mode = document.getElementById('mode-filter').value;
        const source = document.getElementById('source-filter').value;
        
        const params = new URLSearchParams();
        if (filter) params.set('filter', filter);
        if (mode) params.set('mode', mode);
        if (source) params.set('source', source);
        params.set('sort', '{{ sort_by }}');
        params.set('order', '{{ sort_order }}');
        
        window.location.href = '{{ url_for("database_view") }}?' + params.toString();
    }
    
    function sortBy(column) {
        const currentSort = '{{ sort_by }}';
        const currentOrder = '{{ sort_order }}';
        
        let newOrder = 'desc';
        if (column === currentSort) {
            newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
        }
        
        const params = new URLSearchParams(window.location.search);
        params.set('sort', column);
        params.set('order', newOrder);
        params.set('page', '1');  // Reset to page 1 when sorting
        
        window.location.href = '{{ url_for("database_view") }}?' + params.toString();
    }
</script>
{% endblock %}
{% endblock %}
